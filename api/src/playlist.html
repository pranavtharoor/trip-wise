<!DOCTYPE html>
<html>
<head>
	<title></title>
	<style type="text/css">
		#headline {
			text-align: center;
		}
		/* Fonts */
		/* Colors */
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: "Source Sans Pro", sans-serif;
		}

		body {
			background: #ecf0f1;
			height: 100vh;
			font-family: 'Source Sans Pro', sans-serif;
			font-size: 1.125rem;
		}

		.icon::before {
			content: '';
			display: inline-block;
			min-height: 25px;
			min-width: 24px;
			background-repeat: no-repeat;
			background-position: center;
			background-size: contain;
		}
		.icon-add::before {
			background-image: url("data:image/svg+xml,%3Csvg width='448' height='448' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient x1='0%25' y1='0%25' y2='100%25' id='a'%3E%3Cstop stop-color='%23EE790F' offset='0%25'/%3E%3Cstop stop-color='%23EB525A' offset='100%25'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M416 176H272V32c0-17.67-14.33-32-32-32h-32c-17.67 0-32 14.33-32 32v144H32c-17.67 0-32 14.33-32 32v32c0 17.67 14.33 32 32 32h144v144c0 17.67 14.33 32 32 32h32c17.67 0 32-14.33 32-32V272h144c17.67 0 32-14.33 32-32v-32c0-17.67-14.33-32-32-32z' fill='url(%23a)' fill-rule='evenodd'/%3E%3C/svg%3E");
		}

		.listing-container {
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			height: calc(100vh-75px);
			margin-top: 75px;
		}
		.listing-container .simple-input {
			width: 100%;
			padding: 1rem;
			margin-bottom: 4rem;
			border: 0;
			font-size: 1.25rem;
			font-weight: 700;
			color: black;
			background: transparent;
			border-bottom: 2px solid transparent;
			border-image: linear-gradient(to right, #ee790f 0%, #eb525a 100%);
			border-image-slice: 1;
			box-sizing: border-box !important;
			border-width: 0px 0px 4px 0px;
			border-radius: 5px;
			box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0);
			transition: .3s ease;
		}
		.listing-container .simple-input:-ms-input-placeholder {
			transition: .3s ease;
			font-weight: 400;
			color: rgba(0, 0, 0, 0.5);
		}
		.listing-container .simple-input::-webkit-input-placeholder {
			transition: .3s ease;
			font-weight: 400;
			color: rgba(0, 0, 0, 0.5);
		}
		.listing-container .simple-input::placeholder {
			transition: .3s ease;
			font-weight: 400;
			color: rgba(0, 0, 0, 0.5);
			opacity: 1;
		}
		.listing-container .simple-input:focus:-ms-input-placeholder {
			color: black;
		}
		.listing-container .simple-input:focus::-webkit-input-placeholder {
			color: black;
		}
		.listing-container .simple-input:focus::placeholder {
			color: black;
		}
		.listing-container .simple-input:hover, .listing-container .simple-input:focus {
			box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.5);
			outline: none;
		}
		.listing-container .inputs-container {
			width: 100%;
			max-width: 400px;
			list-style: none;
		}
		.listing-container .inputs-container > span {
			display: flex;
			justify-content: center;
			align-items: center;
			position: relative;
			padding: 1rem;
			background: #ee790f;
			background: linear-gradient(to right, #ee790f 0%, #eb525a 100%);
			border-radius: 5px;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
			transition: .3s ease;
		}
		.listing-container .inputs-container > span:hover {
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
		}
		.listing-container .inputs-container > span + span {
			margin-top: 1rem;
		}
		.listing-container .inputs-container > span::before {
			content: attr(data-label);
			position: absolute;
			top: 0;
			transform: translateY(calc(-100% - 5px));
			left: 0;
			font-size: 1rem;
		}
		.listing-container .inputs-container > span > input {
			width: 100%;
			padding: 0 .5rem;
			background: transparent;
			border: 1px solid transparent;
			border-left-width: 2px;
			font-family: "Source Sans Pro", sans-serif;
			font-size: 1.125rem;
			font-weight: 700;
			transition: .3s ease;
			animation: editInput 1s infinite;
		}
		.listing-container .inputs-container > span > input:-ms-input-placeholder {
			transition: .3s ease;
			font-weight: 400;
			color: white;
		}
		.listing-container .inputs-container > span > input::-webkit-input-placeholder {
			transition: .3s ease;
			font-weight: 400;
			color: white;
		}
		.listing-container .inputs-container > span > input::placeholder {
			transition: .3s ease;
			font-weight: 400;
			color: white;
			opacity: 1;
		}
		.listing-container .inputs-container > span > input:focus:-ms-input-placeholder {
			color: black;
		}
		.listing-container .inputs-container > span > input:focus::-webkit-input-placeholder {
			color: black;
		}
		.listing-container .inputs-container > span > input:focus::placeholder {
			color: black;
		}
		.listing-container .inputs-container > span > input:hover {
			border-bottom-color: rgba(255, 255, 255, 0.5);
		}
		.listing-container .inputs-container > span > input:focus {
			outline: none;
			animation: none;
			border-bottom-color: rgba(255, 255, 255, 0.5);
		}
		.listing-container .inputs-container > span.js-add-sauce {
			background: transparent;
			box-shadow: none;
			justify-content: flex-start;
			padding: .5rem;
			min-height: 0;
		}
		.listing-container .inputs-container > span.js-add-sauce > a {
			display: flex;
			justify-content: center;
			align-items: center;
			width: 40px;
			height: 40px;
			background: #DFDFDF;
			border-radius: 100%;
			font-size: 0;
			transition: .3s ease;
		}
		.listing-container .inputs-container > span.js-add-sauce > a .icon {
			transition: 0.3s ease;
		}
		.listing-container .inputs-container > span.js-add-sauce > a:hover, .listing-container .inputs-container > span.js-add-sauce > a:focus {
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
			outline: none;
		}
		.listing-container .inputs-container > span.js-add-sauce > a:hover .icon, .listing-container .inputs-container > span.js-add-sauce > a:focus .icon {
			transform: rotate(90deg) scale(1.2);
		}
		.play {
  display: block;
  width: 0;
  height: 0;
  border-top: 50px solid transparent;
  border-bottom: 50px solid transparent;
  border-left: 60px solid #2c3e50;
  margin: 100px auto 50px auto;
  position: relative;
  z-index: 1;
  transition: all 0.3s;
  -webkit-transition: all 0.3s;
  -moz-transition: all 0.3s;
  left: 10px;
}
.play:before {
  content: '';
  position: absolute;
  top: -75px;
  left: -115px;
  bottom: -75px;
  right: -35px;
  border-radius: 50%;
  border: 10px solid #2c3e50;
  z-index: 2;
  transition: all 0.3s;
  -webkit-transition: all 0.3s;
  -moz-transition: all 0.3s;
}
.play:after {
  content: '';
  opacity: 0;
  transition: opacity 0.6s;
  -webkit-transition: opacity 0.6s;
  -moz-transition: opacity 0.6s;
}
.play:hover:before, .play:focus:before {
  transform: scale(1.1);
  -webkit-transform: scale(1.1);
  -moz-transform: scale(1.1);
}
.play.active {
  border-color: transparent;
}
.play.active:after {
  content: '';
  opacity: 1;
  width: 50px;
  height: 80px;
  background: #2c3e50;
  position: absolute;
  right: 5px;
  top: -40px;
  border-left: 20px solid #2c3e50;
  box-shadow: inset 30px 0 0 0 #f9f9f9;
}

		@keyframes editInput {
			0% {
				border-left-color: transparent;
			}
			50% {
				border-left-color: white;
			}
			100% {
				border-left-color: transparent;
			}
		}
		@keyframes bounceError {
			10%, 90% {
				transform: translate3d(-1px, 0, 0);
			}
			20%, 80% {
				transform: translate3d(2px, 0, 0);
			}
			30%, 50%, 70% {
				transform: translate3d(-4px, 0, 0);
			}
			40%, 60% {
				transform: translate3d(4px, 0, 0);
			}
		}

		.topnav {
        overflow: hidden;
        background-color: #006dcc;
      }

      .topnav a {
        float: left;
        color: #f2f2f2;
        text-align: center;
        padding: 14px 16px;
        text-decoration: none;
        font-size: 17px;
      }

      .topnav a:hover {
        background-color: #1e3d94;
        color: ;
      }

      .topnav a.active {
        background-color: #1e3d94;
        color: white;
      }

	</style>
	    <link href="https://sp-bootstrap.global.ssl.fastly.net/8.0.0/sp-bootstrap.min.css" rel="stylesheet" />
			<script
				src="https://code.jquery.com/jquery-3.2.1.min.js"
				integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
				crossorigin="anonymous"></script>
			
			<!-- Include the Web Playback SDK -->
			<script src="https://sdk.scdn.co/spotify-player.js"></script>
			
			<!-- Include our Javascript -->
			<script >
				const hash = window.location.hash
.substring(1)
.split('&')
.reduce(function (initial, item) {
  if (item) {
    var parts = item.split('=');
    initial[parts[0]] = decodeURIComponent(parts[1]);
  }
  return initial;
}, {});
window.location.hash = '';

// Set token
let _token = hash.access_token;

const authEndpoint = 'https://accounts.spotify.com/authorize';

// Replace with your app's client ID, redirect URI and desired scopes
const clientId = 'ef9c41ca2ea544408f06c9dff22bf382';
const redirectUri = 'http://localhost:8080/api/playlist';
const scopes = [
  'streaming',
  'user-read-birthdate',
  'user-read-private',
  'user-modify-playback-state'
];

// If there is no token, redirect to Spotify authorization
if (!_token) {
  window.location = `${authEndpoint}?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scopes.join('%20')}&response_type=token&show_dialog=true`;
}

// Set up the Web Playback SDK
let player;
window.onSpotifyPlayerAPIReady = () => {
  player = new Spotify.Player({
    name: 'Web Playback SDK Template',
    getOAuthToken: cb => { cb(_token); }
  });

  // Error handling
  player.on('initialization_error', e => console.error(e));
  player.on('authentication_error', e => console.error(e));
  player.on('account_error', e => console.error(e));
  player.on('playback_error', e => console.error(e));

  // Playback status updates
  player.on('player_state_changed', state => {
    console.log(state)
    $('#current-track').attr('src', state.track_window.current_track.album.images[0].url);
    $('#current-track-name').text(state.track_window.current_track.name);
  });

  // Ready
  player.on('ready', data => {
    console.log('Ready with Device ID', data.device_id);
    
    // Play a track using our new device ID
    play(data.device_id);
  });

  // Connect to the player!
  player.connect();
}

// Play a specified track on the Web Playback SDK's device ID
function play(device_id) {
  $.ajax({
   url: "https://api.spotify.com/v1/me/player/play?device_id=" + device_id,
   type: "PUT",
   data: JSON.stringify({uris: geturis()}),
   beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'Bearer ' + _token );},
   success: function(data) { 
     console.log(data)
   }
  });
}
			</script>
</head>
<body>
		<div class="topnav">
				<a href="http://localhost:8080/trips">Home</a>
					<a class="active" href="#">Music</a>
			</div>
	<div class="listing-container">
			<a href="#" title="Play video" class="play active"></a>
			<div>
					<form class="inputs-container">
						<input type="text" name="name" placeholder="Add song" list="preds" class="simple-input" id="name">
						<!-- <span onclick="createnewplaylist(); return false;"><p class="js-sauce-name">Create New Playlist</p></span> -->
						<button onclick="addnewsong(); return false;">Add Song</button>
					</form>
				</div>
				<br><br>
		<div class="inputs-container" id="songs">
		</div>
	</div>
	<script type="text/javascript">
		const addSauceButton = document.querySelector('.js-add-sauce > a');


		addSauceButton.onclick = event => {
			event.preventDefault();
			
		}

		const bounceEmptyInput = childEl => {
			childEl.parentNode.style.animation = "bounceError .8s ease";
			childEl.style.animation = "editInput 1s infinite";
			setTimeout(() => { childEl.parentNode.style.animation = "none"; }, 850);
		}

// Slide Function
let slideUp = (target, duration=500) => {
	target.style.transitionProperty = 'height, margin, padding';
	target.style.transitionDuration = duration + 'ms';
	target.style.boxSizing = 'border-box';
	target.style.height = target.offsetHeight + 'px';
	target.offsetHeight;
	target.style.overflow = 'hidden';
	target.style.height = 0;
	target.style.paddingTop = 0;
	target.style.paddingBottom = 0;
	target.style.marginTop = 0;
	target.style.marginBottom = 0;
	window.setTimeout( () => {
		target.style.display = 'none';
		target.style.removeProperty('height');
		target.style.removeProperty('padding-top');
		target.style.removeProperty('padding-bottom');
		target.style.removeProperty('margin-top');
		target.style.removeProperty('margin-bottom');
		target.style.removeProperty('overflow');
		target.style.removeProperty('transition-duration');
		target.style.removeProperty('transition-property');
		//alert("!");
	}, duration);
}

let slideDown = (target, duration=1000) => {
	target.style.removeProperty('display');
	let display = window.getComputedStyle(target).display;

	if (display === 'none')
		display = 'flex';

	target.style.display = display;
	let height = target.offsetHeight;
	target.style.overflow = 'hidden';
	target.style.height = 0;
	target.style.paddingTop = 0;
	target.style.paddingBottom = 0;
	target.style.marginTop = 0;
	target.style.marginBottom = 0;
	target.offsetHeight;
	target.style.boxSizing = 'border-box';
	target.style.transitionProperty = "height, margin, padding";
	target.style.transitionDuration = duration + 'ms';
	target.style.height = height + 'px';
	target.style.removeProperty('padding-top');
	target.style.removeProperty('padding-bottom');
	target.style.removeProperty('margin-top');
	target.style.removeProperty('margin-bottom');
	window.setTimeout( () => {
		target.style.removeProperty('height');
		target.style.removeProperty('overflow');
		target.style.removeProperty('transition-duration');
		target.style.removeProperty('transition-property');
	}, duration);
}
var slideToggle = (target, duration = 500) => {
	if (window.getComputedStyle(target).display === 'none') {
		return slideDown(target, duration);
	} else {
		return slideUp(target, duration);
	}
}
</script>
	<script type="text/javascript">

$(document).ready(function() {
  var icon = $('.play');
  icon.click(function() {
		 icon.toggleClass('active');
		 player.togglePlay();
     return false;
  });
});

	function getCookie(cname) {
  var name = cname + "=";
  var decodedCookie = decodeURIComponent(document.cookie);
  var ca = decodedCookie.split(';');
  for(var i = 0; i <ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}
		const playid = getCookie('playid');
		const searchbar = document.getElementById('name');
		const options = document.getElementById('preds');
		let songs = {};
		let uris = [];

		searchbar.addEventListener('change', updateOptions);
		searchbar.addEventListener('keyup', updateOptions);

		function updateOptions() {
			let val = searchbar.value;
			if(!val || val === '') return;
			fetch('/api/songs/search?q='+val,{
				credentials: "include",
				headers: {
					Accept: 'application/json',
					'Content-Type': 'application/json; charset=utf-8'
				},
				redirect: 'follow',
				referrer: 'no-referrer',
			})
			.then(res => res.json())
			.then(info => {
				console.log(val);
				console.log(info);
				let list = info.data.tracks.items;
				options.innerHTML = "";
				for(let i=0;i<list.length;i++){
					options.innerHTML += `
						<option value="${list[i].name}">
					`;
					songs[list[i].name] = list[i].uri;
				}
			});
		}

		function updatePlaylist() {
			fetch('/api/songs/content?play_id='+playid,{
			credentials: "include",
			headers: {
      	Accept: 'application/json',
      	'Content-Type': 'application/json; charset=utf-8'
    	},
			redirect: 'follow',
			referrer: 'no-referrer',
		})
		.then(res => res.json())
		.then(res=> {
			const node = document.getElementById('songs');
			console.log(res);
			const list = res.data.items;
			uris = [];
			node.innerHTML = '';
			for(let i=0;i<list.length;i++) {
				let song = list[i];
				node.innerHTML += `
					<span style="display: inline-block;display: flex;justify-content: flex-start;width: 100%;">
						<img src="${song.track.album.images[0].url}" style="width:64px;height:64px;" />
						<p class="js-sauce-name" style="padding-left: 10px;">${song.track.name}</p>
					</span>
				`;
				uris.push(song.track.uri);
			}
		});
		}

		function geturis() {
			return uris;
		}
		
		updatePlaylist();

		function addnewsong() {
			let name = document.getElementById('name').value;
			if(!songs[name]) return false;
			console.log('Who\'s there ?');
			fetch('/api/songs/add_song',{
				method: "POST",
				data: JSON.stringify({
					play_id: playid,
					tracks: songs[name]
				}),
				credentials: "include",
				headers: {
					Accept: 'application/json',
					'Content-Type': 'application/json; charset=utf-8'
				},
				redirect: 'follow',
				referrer: 'no-referrer',
			})
			.then(res => res.json())
			.then(info => {
				console.log(info);
				let list = info.data.tracks.items;
				options.innerHTML = "";
				for(let i=0;i<list.length;i++){
					options.innerHTML += `
						<option value="${list[i].name}">
					`;
					songs[list[i].name] = list[i].uri;
				}
			});
		}
	</script>
</body>
</html>